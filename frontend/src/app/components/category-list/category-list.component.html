<div class="categorias-container">
  <div class="header">
    <h2>GestiÃ³n de categorÃ­as</h2>
    <button class="btn-primary" (click)="nuevaCategoria()">
       Nueva categorÃ­a
    </button>
  </div>

  <div *ngIf="cargando" class="loading">
    <p>Cargando categorÃ­as...</p>
  </div>

  <div *ngIf="!cargando && categorias.length === 0" class="empty-state">
    <p>No hay categorÃ­as creadas aÃºn.</p>
    <button class="btn-primary" (click)="nuevaCategoria()">
      Crear primera categorÃ­a
    </button>
  </div>

  <div *ngIf="!cargando && categorias.length > 0" class="categorias-tree">
    <!-- Nivel 0: CategorÃ­as Principales -->
    <div *ngFor="let cat0 of categoriasAgrupadas.nivel0" class="categoria-item nivel-0">
      <div class="categoria-row">
        <button 
          class="expand-btn" 
          (click)="toggleExpand(cat0._id!)"
          [class.expanded]="isExpanded(cat0._id!)">
          {{ isExpanded(cat0._id!) ? 'â–¼' : 'â–º' }}
        </button>
        
        <img *ngIf="cat0.imagen" [src]="cat0.imagen" alt="{{cat0.nombre}}" class="categoria-imagen">
        <span *ngIf="!cat0.imagen && cat0.icono" class="categoria-icono">{{cat0.icono}}</span>
        <span *ngIf="!cat0.imagen && !cat0.icono" class="categoria-icono">ğŸ“</span>
        
        <div class="categoria-info">
          <span class="categoria-nombre">{{cat0.nombre}}</span>
          <span class="categoria-nivel">Principal</span>
        </div>
        
        <div class="categoria-acciones">
          <button class="btn-edit" (click)="editarCategoria(cat0._id!)">Editar</button>
          <button class="btn-delete" (click)="confirmarEliminar(cat0._id!)">Eliminar</button>
        </div>
      </div>

      <!-- Nivel 1: SubcategorÃ­as -->
      <div *ngIf="isExpanded(cat0._id!)" class="subcategorias nivel-1">
        <div *ngFor="let cat1 of obtenerSubcategorias(cat0._id!, 1)" class="categoria-item">
          <div class="categoria-row">
            <button 
              class="expand-btn" 
              (click)="toggleExpand(cat1._id!)"
              [class.expanded]="isExpanded(cat1._id!)">
              {{ isExpanded(cat1._id!) ? 'â–¼' : 'â–º' }}
            </button>
            
            <span *ngIf="cat1.icono" class="categoria-icono">{{cat1.icono}}</span>
            <span *ngIf="!cat1.icono" class="categoria-icono">ğŸ“‚</span>
            
            <div class="categoria-info">
              <span class="categoria-nombre">{{cat1.nombre}}</span>
              <span class="categoria-nivel">SubcategorÃ­a</span>
            </div>
            
            <div class="categoria-acciones">
              <button class="btn-edit" (click)="editarCategoria(cat1._id!)">Editar</button>
              <button class="btn-delete" (click)="confirmarEliminar(cat1._id!)">Eliminar</button>
            </div>
          </div>

          <!-- Nivel 2: Sub-subcategorÃ­as -->
          <div *ngIf="isExpanded(cat1._id!)" class="subcategorias nivel-2">
            <div *ngFor="let cat2 of obtenerSubcategorias(cat1._id!, 2)" class="categoria-item">
              <div class="categoria-row">
                <span class="expand-placeholder"></span>
                
                <span class="categoria-icono">ğŸ“„</span>
                
                <div class="categoria-info">
                  <span class="categoria-nombre">{{cat2.nombre}}</span>
                  <span class="categoria-nivel">Sub-subcategorÃ­a</span>
                </div>
                
                <div class="categoria-acciones">
                  <button class="btn-edit" (click)="editarCategoria(cat2._id!)">Editar</button>
                  <button class="btn-delete" (click)="confirmarEliminar(cat2._id!)">Eliminar</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Popups -->
<app-error-popup 
  *ngIf="popup == 'eliminadaExito'" 
  text="CategorÃ­a eliminada" 
  textAux="La categorÃ­a se eliminÃ³ correctamente" 
  textButton="Aceptar" 
  [closePopup]="close.bind(this)">
</app-error-popup>

<app-error-popup 
  *ngIf="popup == 'errorEliminar'" 
  text="Error al eliminar" 
  textAux="No se pudo eliminar la categorÃ­a" 
  [closePopup]="close.bind(this)">
</app-error-popup>

<app-error-popup 
  *ngIf="popup == 'tieneSubcategorias'" 
  text="No se puede eliminar" 
  textAux="Esta categorÃ­a tiene subcategorÃ­as. ElimÃ­nalas primero." 
  [closePopup]="close.bind(this)">
</app-error-popup>

<app-error-popup 
  *ngIf="popup == 'errorCargar'" 
  text="Error al cargar" 
  textAux="No se pudieron cargar las categorÃ­as" 
  [closePopup]="close.bind(this)">
</app-error-popup>

<!-- Popup de confirmaciÃ³n de eliminaciÃ³n -->
<div *ngIf="popup == 'confirmarEliminar'" class="background" (click)="close()">
  <div class="popup-confirmation" (click)="$event.stopPropagation()">
    <h3>Confirmar eliminaciÃ³n</h3>
    <p>Â¿EstÃ¡s seguro que deseas eliminar esta categorÃ­a?</p>
    <p class="warning">Esta acciÃ³n no se puede deshacer.</p>
    <div class="buttons-container">
      <button class="btn-red" (click)="eliminarCategoria()">SÃ­, eliminar</button>
      <button class="btn-blue-secondary" (click)="close()">Cancelar</button>
    </div>
  </div>
</div>
