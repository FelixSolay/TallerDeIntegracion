<div class="pago-container" *ngIf="!cargando; else loadingTpl">
  <div class="pago-header">
    <h1>Pago del Pedido</h1>
    <button class="btn-volver" (click)="volverAlCarrito()">‚Üê Volver al carrito</button>
  </div>

  <div class="resumen-card">
    <div class="saldo-info">
      <span class="saldo-label">Saldo a favor:</span>
      <span class="saldo-valor">{{ formatearPrecio(saldoAFavor) }}</span>
    </div>

    <div class="total-info">
      <span class="total-label">Total a pagar:</span>
      <span class="total-valor">{{ formatearPrecio(total) }}</span>
    </div>
  </div>

  <div class="items-card" *ngIf="carritoItems.length > 0; else carritoVacio">
    <h2>Productos en tu pedido</h2>
    <div class="item" *ngFor="let item of carritoItems">
      <div class="item-info">
        <h3>{{ item.nombre }}</h3>
        <p>Cantidad: {{ item.cantidad }}</p>
      </div>
      <div class="item-precio">
        <span>{{ formatearPrecio(item.subtotal) }}</span>
      </div>
    </div>
  </div>

  <div class="direccion-card">
    <h2>Direcci√≥n de entrega</h2>
    <p class="direccion-help">
      Completa los datos de la direcci√≥n donde deseas recibir tu pedido.
    </p>
    
    <div class="direccion-grid">
      <div class="form-group col-span-2">
        <label for="calle">Calle *</label>
        <input
          type="text"
          id="calle"
          class="form-input"
          [(ngModel)]="calle"
          placeholder="Ej: Av. Siempre Viva"
          required
        />
      </div>
      
      <div class="form-group">
        <label for="altura">Altura *</label>
        <input
          type="text"
          id="altura"
          class="form-input"
          [(ngModel)]="altura"
          placeholder="Ej: 742"
          required
        />
      </div>
      
      <div class="form-group">
        <label for="piso">Piso</label>
        <input
          type="text"
          id="piso"
          class="form-input"
          [(ngModel)]="piso"
          placeholder="Ej: 4"
        />
      </div>
      
      <div class="form-group">
        <label for="departamento">Depto</label>
        <input
          type="text"
          id="departamento"
          class="form-input"
          [(ngModel)]="departamento"
          placeholder="Ej: B"
        />
      </div>
      
      <div class="form-group">
        <label for="codigoPostal">C√≥digo Postal</label>
        <input
          type="text"
          id="codigoPostal"
          class="form-input"
          [(ngModel)]="codigoPostal"
          placeholder="Ej: 5000"
        />
      </div>
      
      <div class="form-group">
        <label for="ciudad">Ciudad *</label>
        <input
          type="text"
          id="ciudad"
          class="form-input"
          [(ngModel)]="ciudad"
          placeholder="Ej: C√≥rdoba"
          required
        />
      </div>
      
      <div class="form-group">
        <label for="provincia">Provincia *</label>
        <input
          type="text"
          id="provincia"
          class="form-input"
          [(ngModel)]="provincia"
          placeholder="Ej: C√≥rdoba"
          required
        />
      </div>
    </div>
    
    <div class="direccion-error" *ngIf="mensajeError && mensajeError.includes('direcci√≥n')">
      {{ mensajeError }}
    </div>
  </div>

  <div class="metodo-pago">
    <h2>M√©todo de pago</h2>
    <label class="radio-option">
      <input type="radio" name="metodoPago" value="tarjeta" [(ngModel)]="metodoPago" (change)="mostrarQR = false" />
      üí≥ Tarjeta de cr√©dito / d√©bito (Mercado Pago)
    </label>
    <label class="radio-option">
      <input type="radio" name="metodoPago" value="efectivo" [(ngModel)]="metodoPago" (change)="mostrarQR = false" />
      üí∞ Pago en efectivo (contra entrega)
    </label>
    <label class="radio-option">
      <input type="radio" name="metodoPago" value="saldo" [(ngModel)]="metodoPago" (change)="mostrarQR = false" />
      üè¶ Usar saldo a favor
    </label>
  </div>

  <div class="alerta" *ngIf="metodoPago === 'saldo' && saldoAFavor < total">
    ‚ö†Ô∏è Tu saldo a favor es insuficiente para cubrir el total. Selecciona otro m√©todo de pago.
  </div>

  <div class="mensajes">
    <div class="mensaje-exito" *ngIf="mensajeExito">{{ mensajeExito }}</div>
    <div class="mensaje-error" *ngIf="mensajeError">{{ mensajeError }}</div>
  </div>

  <button 
    class="btn-pagar"
    (click)="pagar()"
    [disabled]="carritoItems.length === 0 || procesandoPago || generandoQR || (metodoPago === 'saldo' && saldoAFavor < total) || !calle.trim() || !altura.trim() || !ciudad.trim() || !provincia.trim()"
  >
    {{ generandoQR ? 'Generando QR...' : procesandoPago ? 'Procesando...' : 'Confirmar pago' }}
  </button>

  <!-- MODAL QR MERCADO PAGO -->
  <div class="qr-modal" *ngIf="mostrarQR">
    <div class="qr-modal-content">
      <div class="qr-header">
        <h2>üí≥ Pago con Mercado Pago</h2>
        <button class="btn-cerrar-qr" (click)="cerrarQR()">‚úï</button>
      </div>

      <div class="qr-body">
        <!-- Informaci√≥n del pago -->
        <div class="pago-info">
          <div class="info-item">
            <span class="label">Monto a pagar:</span>
            <span class="valor">{{ formatearPrecio(total) }}</span>
          </div>
          <div class="info-item">
            <span class="label">Cliente:</span>
            <span class="valor">{{ dni }}</span>
          </div>
          <div class="info-item">
            <span class="label">Expira en:</span>
            <span class="valor" [ngClass]="{'tiempo-bajo': tiempoExpiracion < 60}">
              {{ Math.floor(tiempoExpiracion / 60) }}:{{ (tiempoExpiracion % 60).toString().padStart(2, '0') }}
            </span>
          </div>
        </div>

        <hr class="divisor">

        <!-- QR Code Display -->
        <div class="qr-container" *ngIf="codigoQR">
          <img [src]="codigoQR" alt="QR Code" class="qr-image" />
          <p class="qr-text">Escanea este c√≥digo con tu celular</p>
        </div>

        <hr class="divisor">

        <!-- Opciones de pago -->
        <div class="opciones-pago">
          <button class="btn-opciones btn-escanear" (click)="abrirLinkPago()" *ngIf="linkPago">
            üì± Pagar por link
          </button>
          <button class="btn-opciones btn-copiar" (click)="copiarCodigoQR()">
            üìã Copiar c√≥digo
          </button>
        </div>

        <p class="instruccion">
          1Ô∏è‚É£ Abre Mercado Pago en tu celular<br>
          2Ô∏è‚É£ Escanea el QR o usa el link<br>
          3Ô∏è‚É£ Completa con tu tarjeta<br>
          4Ô∏è‚É£ ¬°Listo! Tu pago se procesar√° autom√°ticamente
        </p>
      </div>

      <div class="qr-footer">
        <p>üîí Pago seguro con Mercado Pago (SANDBOX/TEST)</p>
      </div>
    </div>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="loading">
    <div class="spinner"></div>
    <p>Cargando datos de pago...</p>
  </div>
</ng-template>

<ng-template #carritoVacio>
  <div class="carrito-vacio">
    <p>No hay productos en el carrito. Agrega art√≠culos antes de realizar el pago.</p>
    <button class="btn-volver" (click)="volverAlCarrito()">Ir al carrito</button>
  </div>
</ng-template>
