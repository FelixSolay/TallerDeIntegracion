<div class="promos-container">
  <div class="promos-header">
    <h1>Promociones especiales</h1>
    <p class="subtitle">Aprovech√° los descuentos vigentes y llev√° tus productos favoritos al mejor precio.</p>
  </div>

  <!-- Filtros -->
  <div class="filtros-container" *ngIf="!cargando && !error && promociones.length > 0">
    <div class="filtro-grupo">
      <label for="categoria-filter">Filtrar por categor√≠a</label>
      <select 
        id="categoria-filter" 
        [(ngModel)]="categoriaSeleccionada" 
        (change)="onCategoriaChange()"
        class="filtro-select">
        <option value="">Todas las categor√≠as</option>
        <ng-container *ngFor="let grupo of gruposCategorias">
          <option 
            *ngFor="let cat of grupo.hijos" 
            [value]="cat._id"
            [ngClass]="'nivel-' + cat.nivel">
            {{ getEtiquetaCategoriaOption(cat) }}
          </option>
        </ng-container>
        <option 
          *ngFor="let cat of huerfanos" 
          [value]="cat._id"
          [ngClass]="'nivel-' + cat.nivel">
          {{ getEtiquetaCategoriaOption(cat) }}
        </option>
      </select>
    </div>

    <div class="acciones-filtro">
      <button 
        type="button"
        class="btn-filtrar" 
        (click)="onCategoriaChange()">
        Filtrar
      </button>
      <button 
        *ngIf="categoriaSeleccionada !== ''" 
        class="btn-limpiar-filtros" 
        (click)="limpiarFiltros()">
        Limpiar filtros
      </button>
    </div>

    <div class="filtro-info">
      <div class="info-texto">
        <span *ngIf="categoriaSeleccionada === ''">
          Mostrando todas las promociones ({{ promocionesFiltradas.length }})
        </span>
        <span *ngIf="categoriaSeleccionada !== ''">
          {{ promocionesFiltradas.length }} promoci√≥n(es) en: <strong>{{ getNombreCategoria(categoriaSeleccionada) }}</strong>
        </span>
      </div>
      <div class="orden-inline">
        <label for="orden-promos">Ordenar por</label>
        <select 
          id="orden-promos"
          class="orden-select"
          [(ngModel)]="ordenSeleccionado"
          (change)="onOrdenChange()">
          <option value="relevancia">M√°s relevantes</option>
          <option value="nombre-asc">Nombre A ‚Üí Z</option>
          <option value="nombre-desc">Nombre Z ‚Üí A</option>
          <option value="precio-asc">Precio menor a mayor</option>
          <option value="precio-desc">Precio mayor a menor</option>
        </select>
      </div>
    </div>
  </div>

  <div *ngIf="cargando" class="estado estado-loading">
    <p>Cargando promociones...</p>
  </div>

  <div *ngIf="!cargando && error" class="estado estado-error">
    <p>{{ error }}</p>
  </div>

  <div *ngIf="!cargando && !error && promociones.length === 0" class="estado estado-empty">
    <p>No hay promociones activas en este momento. Volv√© pronto para descubrir nuevas ofertas.</p>
  </div>

  <div *ngIf="!cargando && !error && categoriaSeleccionada !== '' && promocionesFiltradas.length === 0" class="estado estado-empty">
    <p>No hay promociones disponibles en esta categor√≠a.</p>
    <button class="btn-secondary" (click)="limpiarFiltros()">Ver todas las promociones</button>
  </div>

  <div *ngIf="!cargando && !error && promocionesFiltradas.length > 0" class="productos-grid">
    <div class="producto-card" *ngFor="let item of promocionesFiltradas">
      <div class="producto-imagen-container">
        <img
          *ngIf="item.producto.imagen"
          [src]="item.producto.imagen"
          [alt]="item.producto.nombre"
          class="producto-imagen"
        />
        <div *ngIf="!item.producto.imagen" class="producto-sin-imagen">
          <span>üéâ</span>
        </div>
        <div
          *ngIf="item.producto.stock !== undefined && item.producto.stock <= 5"
          class="badge-stock-bajo"
        >
          {{ item.producto.stock === 0 ? 'Sin stock' : '√öltimas unidades' }}
        </div>
      </div>

      <div class="producto-info">
        <h3 class="producto-nombre">{{ item.producto.nombre }}</h3>
        <p *ngIf="item.producto.descripcion" class="producto-descripcion">
          {{ item.producto.descripcion }}
        </p>
        <div class="producto-precio-container con-promocion">
          <div class="precio-wrapper">
            <span class="producto-precio precio-promocional">{{ formatearPrecio(item.precioVigente) }}</span>
            <span class="producto-precio-original">{{ formatearPrecio(obtenerPrecioOriginal(item)) }}</span>
          </div>
          <span class="producto-badge-promocion">{{ formatearEtiquetaPromocion(item) }}</span>
          <span *ngIf="item.producto.stock !== undefined" class="producto-stock">
            Stock: {{ item.producto.stock }}
          </span>
        </div>
      </div>

      <div class="producto-acciones">
        <div class="botones-compra">
          <!-- Mostrar bot√≥n "Agregar" solo si NO est√° en el carrito -->
          <button
            *ngIf="!item.cantidadEnCarrito || item.cantidadEnCarrito === 0"
            class="btn-agregar-carrito"
            (click)="agregarAlCarrito(item)"
            [disabled]="item.producto.stock === 0"
          >
            üõí Llevar promoci√≥n
          </button>

          <!-- Mostrar controles del carrito en l√≠nea si ya est√° agregado -->
          <div class="cantidad-carrito-inline" *ngIf="item.cantidadEnCarrito && item.cantidadEnCarrito > 0">
            <button 
              class="btn-cantidad-carrito" 
              (click)="decrementarEnCarrito(item)"
              [disabled]="item.cantidadEnCarrito <= 0">
              ‚àí
            </button>
            <span class="cantidad-en-carrito">{{item.cantidadEnCarrito}}</span>
            <button 
              class="btn-cantidad-carrito" 
              (click)="incrementarEnCarrito(item)"
              [disabled]="item.producto.stock !== undefined && item.cantidadEnCarrito >= item.producto.stock">
              +
            </button>
          </div>

          <button
            type="button"
            class="btn-favorito"
            [class.active]="item.esFavorito"
            [attr.aria-pressed]="item.esFavorito"
            [disabled]="!item.producto._id"
            (click)="toggleFavorito(item)"
            [title]="item.esFavorito ? 'Quitar de favoritos' : 'Agregar a favoritos'"
          >
            <span>{{ item.esFavorito ? '‚ù§Ô∏è' : 'ü§ç' }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
