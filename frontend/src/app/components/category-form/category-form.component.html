<div class="crear-categoria-container">
  <div class="header">
    <h2>{{ esEdicion ? 'Editar categor√≠a' : 'Nueva categor√≠a' }}</h2>
  </div>

  <form [formGroup]="categoriaForm" (ngSubmit)="onSubmit()" class="categoria-form">
    
    <!-- Nivel de categor√≠a -->
    <div class="form-group">
      <label for="nivel">Tipo de categor√≠a *</label>
      <select id="nivel" formControlName="nivel" class="form-control">
        <option [ngValue]="0">Categor√≠a principal (Nivel 0)</option>
        <option [ngValue]="1">Subcategor√≠a (Nivel 1)</option>
        <option [ngValue]="2">Sub-subcategor√≠a (Nivel 2)</option>
      </select>
    </div>

    <!-- Categor√≠a Padre (solo si nivel > 0) -->
    <div class="form-group" *ngIf="categoriaForm.get('nivel')?.value! > 0">
      <label for="categoriaPadre">Categor√≠a padre *</label>
      <select 
        id="categoriaPadre" 
        formControlName="categoriaPadreId" 
        class="form-control"
        required>
        <option [value]="null">Seleccionar categor√≠a padre...</option>
        <option *ngFor="let padre of categoriasPadres" [value]="padre._id">
          {{ padre.nombre }}
        </option>
      </select>
      <small class="form-hint">
        Selecciona la categor√≠a {{ categoriaForm.get('nivel')?.value === 1 ? 'principal' : 'de nivel 1' }} 
        a la que pertenece
      </small>
    </div>

    <!-- Nombre -->
    <div class="form-group">
      <label for="nombre">Nombre de la categor√≠a *</label>
      <input 
        type="text" 
        id="nombre" 
        formControlName="nombre" 
        class="form-control"
        placeholder="Ej: Almac√©n, Golosinas, Alfajores..."
        required>
      <div *ngIf="categoriaForm.get('nombre')?.invalid && categoriaForm.get('nombre')?.touched" class="error-msg">
        El nombre es obligatorio
      </div>
    </div>

    <!-- Descripci√≥n -->
    <div class="form-group">
      <label for="descripcion">Descripci√≥n (Opcional)</label>
      <textarea 
        id="descripcion" 
        formControlName="descripcion" 
        class="form-control"
        rows="3"
        placeholder="Descripci√≥n de la categor√≠a...">
      </textarea>
    </div>

    <!-- Imagen (solo para nivel 0) -->
    <div class="form-group" *ngIf="categoriaForm.get('nivel')?.value === 0">
      <label>Imagen de la categor√≠a (Recomendado)</label>
      <div class="image-upload-container">
        
        <!-- Preview de la imagen -->
        <div class="image-preview" *ngIf="imagenPreview">
          <img [src]="imagenPreview" alt="Preview">
          <button type="button" class="btn-remove-image" (click)="eliminarImagen()">
            ‚úï
          </button>
        </div>

        <!-- Bot√≥n para seleccionar imagen -->
        <div class="upload-btn-container" *ngIf="!imagenPreview">
          <label for="imagen" class="btn-upload">
            üì∑ Seleccionar imagen
          </label>
          <input 
            type="file" 
            id="imagen" 
            accept="image/*"
            (change)="onImageSelected($event)"
            style="display: none;">
          <small class="form-hint">
            Tama√±o recomendado: 128x128px. M√°ximo 5MB.
          </small>
        </div>
      </div>
    </div>

    <!-- Icono (para nivel 1 y 2, opcional) -->
    <div class="form-group" *ngIf="categoriaForm.get('nivel')?.value! > 0">
      <label for="icono">Emoji/Icono (Opcional)</label>
      <input 
        type="text" 
        id="icono" 
        formControlName="icono" 
        class="form-control"
        placeholder="üçï (puedes copiar un emoji aqu√≠)"
        maxlength="2">
      <small class="form-hint">
        Copia y pega un emoji para representar la categor√≠a
      </small>
    </div>

    <!-- Orden -->
    <div class="form-group">
      <label for="orden">Orden de visualizaci√≥n</label>
      <input 
        type="number" 
        id="orden" 
        formControlName="orden" 
        class="form-control"
        min="0"
        placeholder="0">
      <small class="form-hint">
        Menor n√∫mero aparece primero (0 = primero)
      </small>
    </div>

    <!-- Botones -->
    <div class="form-actions">
      <button type="button" class="btn-secondary" (click)="cancelar()" [disabled]="cargando">
        Cancelar
      </button>
      <button 
        type="submit" 
        class="btn-primary" 
        [disabled]="categoriaForm.invalid || cargando || subiendoImagen">
        <span *ngIf="!cargando && !subiendoImagen">
          {{ esEdicion ? 'Actualizar categor√≠a' : 'Crear categor√≠a' }}
        </span>
        <span *ngIf="subiendoImagen">Subiendo imagen...</span>
        <span *ngIf="cargando && !subiendoImagen">Guardando...</span>
      </button>
    </div>
  </form>
</div>

<!-- Popups de √©xito -->
<app-error-popup 
  *ngIf="popup == 'exito'" 
  text="¬°Categor√≠a creada!" 
  textAux="La categor√≠a se cre√≥ correctamente" 
  textButton="Aceptar" 
  [closePopup]="close.bind(this)">
</app-error-popup>

<app-error-popup 
  *ngIf="popup == 'exitoActualizar'" 
  text="¬°Categor√≠a actualizada!" 
  textAux="Los cambios se guardaron correctamente" 
  textButton="Aceptar" 
  [closePopup]="close.bind(this)">
</app-error-popup>

<!-- Popups de error -->
<app-error-popup 
  *ngIf="popup == 'error'" 
  text="Error" 
  textAux="No se pudo guardar la categor√≠a" 
  [closePopup]="close.bind(this)">
</app-error-popup>

<app-error-popup 
  *ngIf="popup == 'formularioInvalido'" 
  text="Formulario incompleto" 
  textAux="Por favor completa todos los campos obligatorios" 
  [closePopup]="close.bind(this)">
</app-error-popup>

<app-error-popup 
  *ngIf="popup == 'nombreRequerido'" 
  text="Nombre requerido" 
  textAux="Debes ingresar un nombre para la categor√≠a" 
  [closePopup]="close.bind(this)">
</app-error-popup>

<app-error-popup 
  *ngIf="popup == 'padreRequerido'" 
  text="Categor√≠a padre requerida" 
  textAux="Debes seleccionar una categor√≠a padre" 
  [closePopup]="close.bind(this)">
</app-error-popup>

<app-error-popup 
  *ngIf="popup == 'categoriaExiste'" 
  text="Categor√≠a duplicada" 
  textAux="Ya existe una categor√≠a con ese nombre en este nivel" 
  [closePopup]="close.bind(this)">
</app-error-popup>

<app-error-popup 
  *ngIf="popup == 'archivoInvalido'" 
  text="Archivo inv√°lido" 
  textAux="Por favor selecciona una imagen v√°lida (JPG, PNG, etc.)" 
  [closePopup]="close.bind(this)">
</app-error-popup>

<app-error-popup 
  *ngIf="popup == 'archivoGrande'" 
  text="Archivo muy grande" 
  textAux="La imagen debe ser menor a 5MB" 
  [closePopup]="close.bind(this)">
</app-error-popup>

<app-error-popup 
  *ngIf="popup == 'errorSubirImagen'" 
  text="Error al subir imagen" 
  textAux="No se pudo subir la imagen. Intenta nuevamente." 
  [closePopup]="close.bind(this)">
</app-error-popup>

<app-error-popup 
  *ngIf="popup == 'errorCargar'" 
  text="Error al cargar" 
  textAux="No se pudo cargar la categor√≠a" 
  [closePopup]="close.bind(this)">
</app-error-popup>
