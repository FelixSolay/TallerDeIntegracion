<div class="favoritos-container">
    <div class="favoritos-header">
        <h1>Mis favoritos</h1>
        <p class="subtitle">Guarda tus productos preferidos y accede rÃ¡pido cuando quieras comprarlos.</p>
    </div>

    <div *ngIf="cargando" class="loading">
        <p>Cargando tus favoritos...</p>
    </div>

    <div *ngIf="!cargando && errorMensaje" class="error-state">
        <p>{{ errorMensaje }}</p>
        <a routerLink="/productos" class="btn-secondary">Explorar productos</a>
    </div>

    <div *ngIf="!cargando && !errorMensaje && favoritos.length === 0" class="empty-state">
        <p>No tienes productos marcados como favoritos todavÃ­a.</p>
        <a routerLink="/productos" class="btn-primary">Descubrir productos</a>
    </div>

    <!-- Filtros -->
    <div class="filtros-container" *ngIf="!cargando && !errorMensaje && favoritos.length > 0">
        <div class="filtro-grupo">
            <label for="categoria-filter">Filtrar por categorÃ­a</label>
            <select 
                id="categoria-filter" 
                [(ngModel)]="categoriaSeleccionada" 
                (change)="onCategoriaChange()"
                class="filtro-select">
                <option value="">Todas las categorÃ­as</option>
                <ng-container *ngFor="let grupo of gruposCategorias">
                    <option 
                        *ngFor="let cat of grupo.hijos" 
                        [value]="cat._id"
                        [ngClass]="'nivel-' + cat.nivel">
                        {{ getEtiquetaCategoriaOption(cat) }}
                    </option>
                </ng-container>
                <option 
                    *ngFor="let cat of huerfanos" 
                    [value]="cat._id"
                    [ngClass]="'nivel-' + cat.nivel">
                    {{ getEtiquetaCategoriaOption(cat) }}
                </option>
            </select>
        </div>

        <div class="acciones-filtro">
            <button 
                type="button"
                class="btn-filtrar" 
                (click)="onCategoriaChange()">
                Filtrar
            </button>
            <button 
                *ngIf="categoriaSeleccionada !== ''" 
                class="btn-limpiar-filtros" 
                (click)="limpiarFiltros()">
                Limpiar filtros
            </button>
        </div>

        <div class="filtro-info">
            <div class="info-texto">
                <span *ngIf="categoriaSeleccionada === ''">
                    Mostrando todos tus favoritos ({{ favoritosFiltrados.length }})
                </span>
                <span *ngIf="categoriaSeleccionada !== ''">
                    {{ favoritosFiltrados.length }} favorito(s) en: <strong>{{ getNombreCategoria(categoriaSeleccionada) }}</strong>
                </span>
            </div>
            <div class="orden-inline">
                <label for="orden-favoritos">Ordenar por</label>
                <select
                    id="orden-favoritos"
                    class="orden-select"
                    [(ngModel)]="ordenSeleccionado"
                    (change)="onOrdenChange()">
                    <option value="relevancia">MÃ¡s relevantes (descuentos)</option>
                    <option value="nombre-asc">Nombre A â†’ Z</option>
                    <option value="nombre-desc">Nombre Z â†’ A</option>
                    <option value="precio-asc">Precio menor a mayor</option>
                    <option value="precio-desc">Precio mayor a menor</option>
                </select>
            </div>
        </div>
    </div>

    <div *ngIf="!cargando && !errorMensaje && categoriaSeleccionada !== '' && favoritosFiltrados.length === 0" class="empty-state">
        <p>No tienes favoritos en esta categorÃ­a.</p>
        <button class="btn-secondary" (click)="limpiarFiltros()">Ver todos los favoritos</button>
    </div>

    <div *ngIf="!cargando && favoritosFiltrados.length > 0" class="productos-grid favoritos-grid">
        <div *ngFor="let producto of favoritosFiltrados" class="producto-card">
            <div class="producto-imagen-container">
                <img *ngIf="producto.imagen" [src]="producto.imagen" [alt]="producto.nombre" class="producto-imagen">
                <div *ngIf="!producto.imagen" class="producto-sin-imagen">
                    <span>ðŸ“¦</span>
                </div>
                <div *ngIf="producto.stock !== undefined && producto.stock <= 5" class="badge-stock-bajo">
                    {{ producto.stock === 0 ? 'Sin stock' : 'Ãšltimas unidades' }}
                </div>
            </div>

            <div class="producto-info">
                <h3 class="producto-nombre">{{ producto.nombre }}</h3>
                <p *ngIf="producto.descripcion" class="producto-descripcion">{{ producto.descripcion }}</p>
                <div class="producto-precio-container" [class.con-promocion]="producto.promocion">
                    <div class="precio-wrapper">
                        <span class="producto-precio" [class.precio-promocional]="producto.promocion">
                            {{ formatearPrecio(producto.precioVigente) }}
                        </span>
                        <span *ngIf="producto.promocion" class="producto-precio-original">
                            {{ formatearPrecio(obtenerPrecioOriginal(producto)) }}
                        </span>
                    </div>
                    <span *ngIf="producto.promocion" class="producto-badge-promocion">
                        {{ formatearEtiquetaPromocion(producto) }}
                    </span>
                    <span *ngIf="producto.stock !== undefined" class="producto-stock">Stock: {{ producto.stock }}</span>
                </div>
            </div>

            <div class="producto-acciones">
                <div class="cantidad-selector">
                    <button class="btn-cantidad" (click)="decrementarCantidad(producto)" [disabled]="producto.cantidad <= 1">âˆ’</button>
                    <span class="cantidad-display">{{ producto.cantidad }}</span>
                    <button class="btn-cantidad" (click)="incrementarCantidad(producto)" [disabled]="producto.stock !== undefined && producto.cantidad >= producto.stock">+</button>
                </div>
                <div class="botones-compra">
                    <button class="btn-agregar-carrito" (click)="agregarAlCarrito(producto)" [disabled]="producto.stock === 0">
                        ðŸ›’ Agregar al carrito
                    </button>
                    <button 
                        class="btn-favorito btn-remover-favorito"
                        type="button"
                        (click)="removerFavorito(producto)"
                        [disabled]="!producto._id"
                        title="Quitar de favoritos"
                        aria-label="Quitar de favoritos">
                        <span>âœ•</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
