<div class="ventas-container">
  <div class="ventas-header">
    <h1>Ventas - Pedidos de clientes</h1>
    <div class="filtros">
      <label>
        Estado
        <select [(ngModel)]="filtroEstado" (change)="cargarPedidos()">
          <option value="">Todos</option>
          <option value="pendiente">Pendiente</option>
          <option value="entregado">Entregado</option>
          <option value="cancelado">Cancelado</option>
        </select>
      </label>
      <label>
        DNI
        <input [(ngModel)]="filtroDni" placeholder="Ej: 12345678" />
      </label>
      <label>
        Fecha desde
        <input type="date" [(ngModel)]="filtroFechaDesde" />
      </label>
      <label>
        Fecha hasta
        <input type="date" [(ngModel)]="filtroFechaHasta" />
      </label>
      <div class="filtro-acciones">
        <button class="btn" (click)="cargarPedidos()">Filtrar</button>
        <button class="btn secondary" (click)="limpiarFiltros()">Limpiar</button>
      </div>
    </div>
  </div>

  <div *ngIf="cargando" class="loading">Cargando pedidos...</div>
  <div *ngIf="!cargando && error" class="error">{{ error }}</div>

  <div *ngIf="!cargando && !error">
    <table class="tabla">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>DNI</th>
          <th>Dirección</th>
          <th>Total</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let p of pedidos">
          <td>{{ p.creadoEl | date:'short' }}</td>
          <td>{{ p.dni }}</td>
          <td>{{ p.direccionEntrega }}</td>
          <td>{{ p.total | currency:'ARS' }}</td>
          <td>
            <span class="badge" [class.pendiente]="p.estado==='pendiente'" [class.entregado]="p.estado==='entregado'" [class.cancelado]="p.estado==='cancelado'">
              {{ p.estado }}
            </span>
          </td>
          <td class="acciones">
            <button class="btn info" (click)="verDetalle(p)">Detalle</button>
            <button class="btn success" (click)="despachar(p)" [disabled]="p.estado!=='pendiente'">Despachar</button>
            <button class="btn danger" (click)="cancelar(p)" [disabled]="p.estado!=='pendiente'">Cancelar</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="reportes">
    <h2>Reportes de ventas</h2>
    <p>Configurá el periodo con el calendario (formato dd/mm/aaaa) y generá el PDF desde cada panel.</p>

      <div class="reportes-row">
    <section class="reporte-panel" [class.abierto]="panelActivo==='top'">
      <button class="reporte-header" type="button" (click)="togglePanel('top')">
        <div>
          <strong>Top productos más vendidos</strong>
          <p>Elegí la cantidad y el periodo para listar los productos destacados.</p>
        </div>
        <span class="chevron" [class.abierto]="panelActivo==='top'">⌄</span>
      </button>
      <div class="reporte-content" *ngIf="panelActivo==='top'">
        <form (ngSubmit)="generarReporteTopProductos()" novalidate>
          <div class="form-grid">
            <label>
              Cantidad de productos
              <input type="number" min="1" [(ngModel)]="topForm.limite" name="topLimite" required />
            </label>
            <label>
              Desde
              <input
                type="date"
                [(ngModel)]="topForm.fechaDesde"
                name="topDesde"
                class="date-input"
                aria-describedby="top-formato"
              />
            </label>
            <label>
              Hasta
              <input
                type="date"
                [(ngModel)]="topForm.fechaHasta"
                name="topHasta"
                class="date-input"
                aria-describedby="top-formato"
              />
            </label>
          </div>
          <p id="top-formato" class="campo-ayuda">Dejá las fechas vacías para incluir todo el historial.</p>
          <button class="btn info" type="submit" [disabled]="reporteProcesando">
            {{ reporteProcesando ? 'Generando...' : 'Generar PDF' }}
          </button>
          <div
            class="mensaje-panel"
            *ngIf="reporteMensaje && panelMensaje==='top'"
            [class.error]="reporteMensajeTipo==='error'"
            [class.info]="reporteMensajeTipo==='info'"
            [class.success]="reporteMensajeTipo==='success'"
          >
            <span>{{ reporteMensaje }}</span>
            <button type="button" (click)="resetMensaje()">Cerrar</button>
          </div>
        </form>
      </div>
    </section>

    <section class="reporte-panel" [class.abierto]="panelActivo==='categoria'">
      <button class="reporte-header" type="button" (click)="togglePanel('categoria')">
        <div>
          <strong>Ventas por categoría</strong>
          <p>Analizá cantidades e ingresos agrupados por categoría.</p>
        </div>
        <span class="chevron" [class.abierto]="panelActivo==='categoria'">⌄</span>
      </button>
      <div class="reporte-content" *ngIf="panelActivo==='categoria'">
        <form (ngSubmit)="generarReportePorCategoria()" novalidate>
          <div class="form-grid">
            <label>
              Desde
              <input
                type="date"
                [(ngModel)]="categoriaForm.fechaDesde"
                name="catDesde"
                class="date-input"
                aria-describedby="cat-formato"
              />
            </label>
            <label>
              Hasta
              <input
                type="date"
                [(ngModel)]="categoriaForm.fechaHasta"
                name="catHasta"
                class="date-input"
                aria-describedby="cat-formato"
              />
            </label>
          </div>
          <p id="cat-formato" class="campo-ayuda">Si dejás ambos campos vacíos, se incluirán todas las fechas.</p>
          <button class="btn info" type="submit" [disabled]="reporteProcesando">
            {{ reporteProcesando ? 'Generando...' : 'Generar PDF' }}
          </button>
          <div
            class="mensaje-panel"
            *ngIf="reporteMensaje && panelMensaje==='categoria'"
            [class.error]="reporteMensajeTipo==='error'"
            [class.info]="reporteMensajeTipo==='info'"
            [class.success]="reporteMensajeTipo==='success'"
          >
            <span>{{ reporteMensaje }}</span>
            <button type="button" (click)="resetMensaje()">Cerrar</button>
          </div>
        </form>
      </div>
    </section>

    <section class="reporte-panel" [class.abierto]="panelActivo==='periodo'">
      <button class="reporte-header" type="button" (click)="togglePanel('periodo')">
        <div>
          <strong>Reporte por periodo</strong>
          <p>Compará pedidos, productos e ingresos día a día.</p>
        </div>
        <span class="chevron" [class.abierto]="panelActivo==='periodo'">⌄</span>
      </button>
      <div class="reporte-content" *ngIf="panelActivo==='periodo'">
        <form (ngSubmit)="generarReportePorPeriodo()" novalidate>
          <div class="form-grid">
            <label>
              Desde
              <input
                type="date"
                [(ngModel)]="periodoForm.fechaDesde"
                name="periodoDesde"
                class="date-input"
                required
              />
            </label>
            <label>
              Hasta
              <input
                type="date"
                [(ngModel)]="periodoForm.fechaHasta"
                name="periodoHasta"
                class="date-input"
                required
              />
            </label>
          </div>
          <p class="campo-ayuda">Ambas fechas son obligatorias para este reporte.</p>
          <button class="btn info" type="submit" [disabled]="reporteProcesando">
            {{ reporteProcesando ? 'Generando...' : 'Generar PDF' }}
          </button>
          <div
            class="mensaje-panel"
            *ngIf="reporteMensaje && panelMensaje==='periodo'"
            [class.error]="reporteMensajeTipo==='error'"
            [class.info]="reporteMensajeTipo==='info'"
            [class.success]="reporteMensajeTipo==='success'"
          >
            <span>{{ reporteMensaje }}</span>
            <button type="button" (click)="resetMensaje()">Cerrar</button>
          </div>
        </form>
      </div>
    </section>
      </div>
  </div>

  <!-- Modal Detalle de Pedido -->
  <div class="modal-backdrop" *ngIf="pedidoDetalle">
    <div class="modal">
      <div class="modal-header">
        <h2>Detalle de pedido</h2>
        <button class="close" (click)="cerrarDetalle()">✕</button>
      </div>
      <div class="modal-body" *ngIf="pedidoDetalle as pd">
        <div class="grid">
          <div>
            <label>DNI</label>
            <div>{{ pd.dni }}</div>
          </div>
          <div>
            <label>Estado</label>
            <div>{{ pd.estado }}</div>
          </div>
          <div>
            <label>Creado</label>
            <div>{{ pd.creadoEl | date:'short' }}</div>
          </div>
          <div>
            <label>Entrega</label>
            <div>{{ pd.fechaEntrega ? (pd.fechaEntrega | date:'short') : '-' }}</div>
          </div>
        </div>
        <div class="mt">
          <label>Dirección de entrega</label>
          <div>{{ pd.direccionEntrega }}</div>
        </div>
        <div class="mt">
          <label>Productos</label>
          <table class="items-tabla">
            <thead>
              <tr>
                <th>Producto</th>
                <th class="right">Cant.</th>
                <th class="right">Precio</th>
                <th class="right">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let it of pd.items">
                <td>{{ it.nombre }}</td>
                <td class="right">{{ it.cantidad }}</td>
                <td class="right">{{ it.precioUnitario | currency:'ARS' }}</td>
                <td class="right">{{ it.subtotal | currency:'ARS' }}</td>
              </tr>
            </tbody>
          </table>
          <div class="total">
            <span>Total</span>
            <strong>{{ pd.total | currency:'ARS' }}</strong>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" (click)="cerrarDetalle()">Cerrar</button>
      </div>
    </div>
  </div>
</div>
